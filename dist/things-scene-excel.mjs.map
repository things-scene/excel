{"version":3,"file":"things-scene-excel.mjs","sources":["../src/excel.png","../src/excel.js","../src/index.js"],"sourcesContent":["export default \"data:image/png;base64,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\"","/*\n * Copyright © HatioLab Inc. All rights reserved.\n */\n\nimport COMPONENT_IMAGE from \"./excel.png\";\n\nimport { Component, DataSource, RectPath, Shape } from \"@hatiolab/things-scene\";\nimport XLSX from \"xlsx\";\n\nconst NATURE = {\n  mutable: false,\n  resizable: true,\n  rotatable: true,\n  properties: [\n    {\n      type: \"string\",\n      label: \"src\",\n      name: \"src\",\n      placeholder: \"Excel File URL\"\n    },\n    {\n      type: \"number\",\n      label: \"period\",\n      name: \"period\",\n      placeholder: \"seconds\"\n    }\n  ]\n};\n\nasync function fetchData(url) {\n  if (!url.startsWith(\"data:\")) {\n    // prevent read from cache\n    if (url.indexOf(\"?\") !== -1) {\n      url = url + `&ts=${Date.now()}`;\n    } else {\n      url = url + `?ts=${Date.now()}`;\n    }\n  }\n\n  const file = await fetch(url, {\n    method: \"GET\",\n    headers: {\n      \"Content-Type\": \"application/xlsx\"\n    },\n    credentials: \"include\"\n  });\n\n  const workbook = XLSX.read(await file.arrayBuffer(), { type: \"array\" });\n\n  var result = {};\n  workbook.SheetNames.forEach(sheet => {\n    var roa = XLSX.utils.sheet_to_json(workbook.Sheets[sheet]);\n    if (roa.length) {\n      result[sheet] = roa;\n    }\n  });\n\n  console.log(\"result\", result);\n  return result;\n}\n\nexport default class Excel extends DataSource(RectPath(Shape)) {\n  static get image() {\n    if (!Excel._image) {\n      Excel._image = new Image();\n      Excel._image.src = COMPONENT_IMAGE;\n    }\n\n    return Excel._image;\n  }\n\n  dispose() {\n    this._stopRepeater();\n    super.dispose();\n  }\n\n  ready() {\n    const { src } = this.state;\n\n    if (src) {\n      this._initInterval();\n    }\n  }\n\n  render(context) {\n    /*\n     * TODO role이 publisher 인지 subscriber 인지에 따라서 구분할 수 있는 표시를 추가할 것.\n     */\n\n    var { left, top, width, height } = this.bounds;\n\n    context.beginPath();\n    context.drawImage(Excel.image, left, top, width, height);\n  }\n\n  get nature() {\n    return NATURE;\n  }\n\n  _initInterval() {\n    this._stopRepeater();\n    this._startRepeater();\n  }\n\n  _startRepeater() {\n    var { src, period } = this.state;\n    period = Number(period);\n\n    var fetchable = true;\n\n    if (period && this.app.isViewMode) {\n      this.repeatTimer = setInterval(() => {\n        fetchable &&\n          this.repeatTimer &&\n          requestAnimationFrame(() => {\n            fetchable = true;\n            fetchData(src).then(data => {\n              this.setState(\"data\", data);\n            });\n          });\n        fetchable = false;\n      }, period * 1000);\n    }\n\n    fetchData(src).then(data => {\n      this.setState(\"data\", data);\n    });\n  }\n\n  _stopRepeater() {\n    if (this.repeatTimer) clearTimeout(this.repeatTimer);\n\n    delete this.repeatTimer;\n  }\n\n  ondropfile(transfered, files) {\n    for (let i = 0; i < transfered.length; i++) {\n      if (/\\.xlsx?$/.test(transfered[i].name)) {\n        this.src = files[i];\n        return;\n      }\n    }\n  }\n\n  onchange(after, before) {\n    if (\"period\" in after || \"src\" in after) {\n      this._initInterval();\n    }\n  }\n}\n\nComponent.register(\"excel\", Excel);\n","import Excel from \"./excel\";\nexport default [Excel];"],"names":["NATURE","mutable","resizable","rotatable","properties","type","label","name","placeholder","async","fetchData","url","startsWith","indexOf","Date","now","file","fetch","method","headers","credentials","workbook","XLSX","read","arrayBuffer","result","SheetNames","forEach","sheet","roa","utils","sheet_to_json","Sheets","length","console","log","Excel","DataSource","RectPath","Shape","_image","Image","src","COMPONENT_IMAGE","dispose","_stopRepeater","ready","this","state","_initInterval","render","context","left","top","width","height","bounds","beginPath","drawImage","image","_startRepeater","period","Number","fetchable","app","isViewMode","repeatTimer","setInterval","requestAnimationFrame","then","data","setState","clearTimeout","ondropfile","transfered","files","i","test","onchange","after","before","Component","register"],"mappings":"gHAAA,MAAe,q4FCIf,MAKMA,EAAS,CACbC,SAAS,EACTC,WAAW,EACXC,WAAW,EACXC,WAAY,CACV,CACEC,KAAM,SACNC,MAAO,MACPC,KAAM,MACNC,YAAa,kBAEf,CACEH,KAAM,SACNC,MAAO,SACPC,KAAM,SACNC,YAAa,aAKnBC,eAAeC,EAAUC,GAClBA,EAAIC,WAAW,YAEQ,IAAtBD,EAAIE,QAAQ,KACdF,UAAmBG,KAAKC,QAExBJ,UAAmBG,KAAKC,eAItBC,QAAaC,MAAMN,EAAK,CAC5BO,OAAQ,MACRC,QAAS,gBACS,oBAElBC,YAAa,YAGTC,EAAWC,EAAKC,WAAWP,EAAKQ,cAAe,CAAEnB,KAAM,cAEzDoB,EAAS,UACbJ,EAASK,WAAWC,QAAQC,QACtBC,EAAMP,EAAKQ,MAAMC,cAAcV,EAASW,OAAOJ,IAC/CC,EAAII,SACNR,EAAOG,GAASC,KAIpBK,QAAQC,IAAI,SAAUV,GACfA,EAGT,MAAqBW,UAAcC,EAAWC,EAASC,+BAE9CH,EAAMI,SACTJ,EAAMI,OAAS,IAAIC,MACnBL,EAAMI,OAAOE,IAAMC,GAGdP,EAAMI,OAGfI,eACOC,sBACCD,UAGRE,cACQJ,IAAEA,GAAQK,KAAKC,MAEjBN,QACGO,gBAITC,OAAOC,OAKDC,KAAEA,EAAFC,IAAQA,EAARC,MAAaA,EAAbC,OAAoBA,GAAWR,KAAKS,OAExCL,EAAQM,YACRN,EAAQO,UAAUtB,EAAMuB,MAAOP,EAAMC,EAAKC,EAAOC,uBAI1CvD,EAGTiD,qBACOJ,qBACAe,iBAGPA,qBACMlB,IAAEA,EAAFmB,OAAOA,GAAWd,KAAKC,MAC3Ba,EAASC,OAAOD,OAEZE,GAAY,EAEZF,GAAUd,KAAKiB,IAAIC,kBAChBC,YAAcC,YAAY,KAC7BJ,GACEhB,KAAKmB,aACLE,sBAAsB,KACpBL,GAAY,EACZrD,EAAUgC,GAAK2B,KAAKC,SACbC,SAAS,OAAQD,OAG5BP,GAAY,GACF,IAATF,IAGLnD,EAAUgC,GAAK2B,KAAKC,SACbC,SAAS,OAAQD,KAI1BzB,gBACME,KAAKmB,aAAaM,aAAazB,KAAKmB,oBAEjCnB,KAAKmB,YAGdO,WAAWC,EAAYC,OAChB,IAAIC,EAAI,EAAGA,EAAIF,EAAWzC,OAAQ2C,OACjC,WAAWC,KAAKH,EAAWE,GAAGrE,uBAC3BmC,IAAMiC,EAAMC,IAMvBE,SAASC,EAAOC,IACV,WAAYD,GAAS,QAASA,SAC3B9B,iBAKXgC,EAAUC,SAAS,QAAS9C,iBCtJb,CAACA"}